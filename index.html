<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Penjualan</title>

<style>
/* ====== STYLE PART A (dipertahankan & dirapikan) ====== */

body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 20px;
  background: #f3f4f6;
}

.container {
  display: flex;
  gap: 20px;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.06);
}

.left {
  flex: 1;
}

.right {
  width: 420px;
}

.section-title {
  font-weight: 600;
  margin-bottom: 10px;
}

/* Input oval style versi tampilan lama */
.form-input {
  width: 100%;
  padding: 10px;
  border-radius: 25px;
  border: 1px solid #ccc;
  margin-bottom: 12px;
  outline: none;
  background: #fafafa;
}

.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

/* Dynamic table */
.dyn-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
.dyn-table td, .dyn-table th { border: 1px solid #ddd; padding: 6px; }
.btn-delete { padding: 5px 8px; background: #e11d48; color:white; border:none; border-radius: 6px; }
.btn-add { padding: 7px 10px; background:#2563eb; border:none; color:white; border-radius:6px; margin-bottom:10px; }

/* Laporan */
.report {
  background:white;
  padding:20px;
  border-radius:14px;
  box-shadow:0 4px 8px rgba(0,0,0,0.06);
}

.report h2 { text-align:center; font-size:18px; margin:0; }

.report-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.report-table td {
  border: 1px solid #ddd;
  padding: 6px;
}

.num { text-align: right; }

/* Tombol */
.btn {
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  margin-right: 6px;
}

.btn-blue { background:#0284c7; color:white; }
.btn-green { background:#16a34a; color:white; }
.btn-orange { background:#f97316; color:white; }

</style>

</head>
<body>

<div class="container">

  <!-- ==================== LEFT SIDE (Form Input) ==================== -->
  <div class="card left">

    <h2 class="section-title">TOTAL PENJUALAN</h2>
    <input id="totalPenjualan" type="number" class="form-input" placeholder="0">

    <h2 class="section-title">METODE PEMBAYARAN</h2>

    <div class="grid-2">
      <input id="debitBca" type="number" class="form-input" placeholder="Debit BCA">
      <input id="kreditBca" type="number" class="form-input" placeholder="Kredit BCA">

      <input id="qrBca" type="number" class="form-input" placeholder="QRIS BCA">
      <input id="debitMandiri" type="number" class="form-input" placeholder="Debit Mandiri">

      <input id="qrMandiri" type="number" class="form-input" placeholder="QR Mandiri">
      <input id="debitBri" type="number" class="form-input" placeholder="Debit BRI">

      <input id="qrBri" type="number" class="form-input" placeholder="QR BRI">
      <input id="debitBni" type="number" class="form-input" placeholder="Debit BNI">

      <input id="kreditBni" type="number" class="form-input" placeholder="Kredit BNI">
      <input id="qrBni" type="number" class="form-input" placeholder="QR BNI">

      <input id="shopeePay" type="number" class="form-input" placeholder="ShopeePay">
      <input id="shopee" type="number" class="form-input" placeholder="Shopee">
    </div>

    <h2 class="section-title">TRANSFER BCA</h2>
    <button id="addBca" class="btn-add">+ Tambah Transfer BCA</button>
    <table class="dyn-table">
      <tbody id="bcaTable"></tbody>
    </table>

    <h2 class="section-title">TRANSFER MANDIRI</h2>
    <button id="addMandiri" class="btn-add">+ Tambah Transfer Mandiri</button>
    <table class="dyn-table">
      <tbody id="mandiriTable"></tbody>
    </table>

    <h2 class="section-title">PECAHAN CASH</h2>

    <div class="grid-2">
      <input id="p100" type="number" class="form-input" placeholder="Rp 100.000">
      <input id="p50" type="number" class="form-input" placeholder="Rp 50.000">

      <input id="p20" type="number" class="form-input" placeholder="Rp 20.000">
      <input id="p10" type="number" class="form-input" placeholder="Rp 10.000">

      <input id="p5" type="number" class="form-input" placeholder="Rp 5.000">
      <input id="p2" type="number" class="form-input" placeholder="Rp 2.000">

      <input id="p1" type="number" class="form-input" placeholder="Rp 1.000">
      <input id="receh" type="number" class="form-input" placeholder="Receh">
    </div>

    <h2 class="section-title">PIUTANG</h2>
    <input id="piutang" type="number" class="form-input" placeholder="Jumlah Piutang">

    <h2 class="section-title">BIAYA</h2>
    <button id="addBiaya" class="btn-add">+ Tambah Biaya</button>
    <table class="dyn-table">
      <tbody id="biayaTable"></tbody>
    </table>

    <button onclick="saveServer()" class="btn btn-green">Simpan ke Server</button>
    <button onclick="exportPNG()" class="btn btn-blue">Export PNG</button>
    <button onclick="exportPDF()" class="btn btn-orange">Export PDF</button>

  </div>

  <!-- ==================== RIGHT SIDE (Laporan) ==================== -->
  <div class="card right" id="laporan">
    <h2>LAPORAN PENJUALAN</h2>

    <table class="report-table">
      <tr><td>Total Penjualan</td><td class="num" id="r_totalPenjualan">0</td></tr>
      <tr><td>Total Non-Cash</td><td class="num" id="r_totalNonCash">0</td></tr>
      <tr><td>Total Transfer</td><td class="num" id="r_totalTransfer">0</td></tr>
      <tr><td>Total Biaya</td><td class="num" id="r_totalBiaya">0</td></tr>
      <tr><td>Subtotal</td><td class="num" id="r_subtotal">0</td></tr>
      <tr><td>Grand Total</td><td class="num" id="r_grandTotal">0</td></tr>
      <tr><td>Cash Fisik</td><td class="num" id="r_cashFisik">0</td></tr>
      <tr><td>Cash Seharusnya</td><td class="num" id="r_cashSeharusnya">0</td></tr>
      <tr><td>Plus/Minus</td><td class="num" id="r_plusminus">0</td></tr>
      <tr><td>Minus Asli</td><td class="num" id="r_minusAsli">0</td></tr>
    </table>

    <div id="lastInfo" style="margin-top:10px; font-size:13px; opacity:0.8;"></div>

  </div>

</div>

<!-- =============================
     FIREBASE & SCRIPT (PART B)
============================= -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// FIREBASE INIT
const firebaseConfig = {
  apiKey: "AIzaSyCcDwcdXRnkLaFpYT_kbbjfDwDY-zxoWWY",
  authDomain: "laporan-kopo.firebaseapp.com",
  databaseURL: "https://laporan-kopo-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laporan-kopo",
  storageBucket: "laporan-kopo.firebasestorage.app",
  messagingSenderId: "556164034130",
  appId: "1:556164034130:web:e9f092dcc77925373c398b",
  measurementId: "G-ZTW27GVCQP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<!-- ============ PART B SCRIPT PENUH =========== -->
<script>
<script>
// ========== Helper: Format angka ==========
function num(v) {
    v = parseFloat(v);
    return isNaN(v) ? 0 : v;
}

function format(v) {
    return num(v).toLocaleString("id-ID");
}

// ============================
// Ambil elemen input
// ============================
const totalPenjualanEl = document.getElementById("totalPenjualan");

const shopeePayEl = document.getElementById("shopeePay");
const shopeeEl = document.getElementById("shopee");

const debitBcaEl = document.getElementById("debitBca");
const kreditBcaEl = document.getElementById("kreditBca");
const qrBcaEl = document.getElementById("qrBca");

const debitMandiriEl = document.getElementById("debitMandiri");
const qrMandiriEl = document.getElementById("qrMandiri");

const debitBriEl = document.getElementById("debitBri");
const qrBriEl = document.getElementById("qrBri");

const debitBniEl = document.getElementById("debitBni");
const kreditBniEl = document.getElementById("kreditBni");
const qrBniEl = document.getElementById("qrBni");

const recehEl = document.getElementById("receh");

// Pecahan
const p100El = document.getElementById("p100");
const p50El = document.getElementById("p50");
const p20El = document.getElementById("p20");
const p10El = document.getElementById("p10");
const p5El = document.getElementById("p5");
const p2El = document.getElementById("p2");
const p1El = document.getElementById("p1");

// Piutang
const piutangEl = document.getElementById("piutang");

// Dynamic tables
const biayaTable = document.getElementById("biayaTable");
const btnAddBiaya = document.getElementById("addBiaya");

const bcaTable = document.getElementById("bcaTable");
const btnAddBca = document.getElementById("addBca");

const mandiriTable = document.getElementById("mandiriTable");
const btnAddMandiri = document.getElementById("addMandiri");


// ============================
// Tambah Dynamic Row
// ============================
function addRow(table, max) {
    if (table.rows.length >= max) return alert("Maksimal " + max + " baris!");

    let row = table.insertRow(-1);

    let c1 = row.insertCell(0);
    let c2 = row.insertCell(1);
    let c3 = row.insertCell(2);

    c1.innerHTML = `<input type="text" class="din-input">`;
    c2.innerHTML = `<input type="number" class="din-input num">`;
    c3.innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
}

// Tombol tambah
btnAddBiaya.onclick = () => addRow(biayaTable, 10);
btnAddBca.onclick = () => addRow(bcaTable, 10);
btnAddMandiri.onclick = () => addRow(mandiriTable, 10);


// ============================
// HITUNG AUTOMATIS
// ============================
function hitung() {

    // 1. TOTAL PENJUALAN
    const totalPenjualan = num(totalPenjualanEl.value);

    // 2. TOTAL NON-CASH
    const totalNonCash =
        num(shopeePayEl.value) +
        num(shopeeEl.value) +
        num(debitBcaEl.value) +
        num(kreditBcaEl.value) +
        num(qrBcaEl.value) +
        num(debitMandiriEl.value) +
        num(qrMandiriEl.value) +
        num(debitBriEl.value) +
        num(qrBriEl.value) +
        num(debitBniEl.value) +
        num(kreditBniEl.value) +
        num(qrBniEl.value);

    // 3. TOTAL TRANSFER BCA + MANDIRI (DARI TABEL)
    let totalTransferBca = 0;
    for (let r of bcaTable.rows) {
        totalTransferBca += num(r.cells[1].children[0].value);
    }

    let totalTransferMandiri = 0;
    for (let r of mandiriTable.rows) {
        totalTransferMandiri += num(r.cells[1].children[0].value);
    }

    const totalTransfer = totalTransferBca + totalTransferMandiri;

    // 4. TOTAL BIAYA
    let totalBiaya = 0;
    for (let r of biayaTable.rows) {
        totalBiaya += num(r.cells[1].children[0].value);
    }

    // 5. PIUTANG
    const piutang = num(piutangEl.value);

    // 6. SUBTOTAL = total penjualan (kotor)
    const subtotal = totalPenjualan;

    // 7. GRAND TOTAL = TOTAL PENJUALAN - biaya
    const grandTotal = subtotal - totalBiaya;

    // 8. CASH FISIK = pecahan + receh
    const cashFisik =
        (num(p100El.value) * 100000) +
        (num(p50El.value) * 50000) +
        (num(p20El.value) * 20000) +
        (num(p10El.value) * 10000) +
        (num(p5El.value) * 5000) +
        (num(p2El.value) * 2000) +
        (num(p1El.value) * 1000) +
        num(recehEl.value);

    // 9. CASH SEHARUSNYA
    const cashSeharusnya = grandTotal - totalNonCash - totalTransfer - piutang;

    // 10. PLUS MINUS
    const plusMinus = cashFisik - cashSeharusnya;

    // 11. MINUS ASLI
    const minusAsli = plusMinus < 0 ? Math.abs(plusMinus) : 0;

    // =========================
    // TAMPILKAN DI LAPORAN
    // =========================
    document.getElementById("r_totalPenjualan").innerText = format(totalPenjualan);
    document.getElementById("r_totalNonCash").innerText = format(totalNonCash);
    document.getElementById("r_totalTransfer").innerText = format(totalTransfer);
    document.getElementById("r_totalBiaya").innerText = format(totalBiaya);
    document.getElementById("r_subtotal").innerText = format(subtotal);
    document.getElementById("r_grandTotal").innerText = format(grandTotal);
    document.getElementById("r_cashFisik").innerText = format(cashFisik);
    document.getElementById("r_cashSeharusnya").innerText = format(cashSeharusnya);
    document.getElementById("r_plusminus").innerText = format(plusMinus);
    document.getElementById("r_minusAsli").innerText = format(minusAsli);

}

document.addEventListener("input", hitung);


// ============================
// EXPORT PNG
// ============================
async function exportPNG() {
    const laporan = document.getElementById("laporan");
    const canvas = await html2canvas(laporan);
    const link = document.createElement("a");
    link.download = "laporan.png";
    link.href = canvas.toDataURL();
    link.click();
}

// ============================
// EXPORT PDF
// ============================
async function exportPDF() {
    const laporan = document.getElementById("laporan");
    const canvas = await html2canvas(laporan);
    const imgData = canvas.toDataURL("image/png");

    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, w, h);
    pdf.save("laporan.pdf");
}

// ============================
// SAVE FIREBASE
// ============================
function saveServer() {
    const data = {
        totalPenjualan: totalPenjualanEl.value,
        shopeePay: shopeePayEl.value,
        shopee: shopeeEl.value,
        debitBca: debitBcaEl.value,
        kreditBca: kreditBcaEl.value,
        qrBca: qrBcaEl.value,
        debitMandiri: debitMandiriEl.value,
        qrMandiri: qrMandiriEl.value,
        debitBri: debitBriEl.value,
        qrBri: qrBriEl.value,
        debitBni: debitBniEl.value,
        kreditBni: kreditBniEl.value,
        qrBni: qrBniEl.value,
        receh: recehEl.value,
        p100: p100El.value,
        p50: p50El.value,
        p20: p20El.value,
        p10: p10El.value,
        p5: p5El.value,
        p2: p2El.value,
        p1: p1El.value,
        piutang: piutangEl.value,
        biaya: [],
        transferBca: [],
        transferMandiri: []
    };

    for (let r of biayaTable.rows) {
        data.biaya.push({
            nama: r.cells[0].children[0].value,
            nominal: r.cells[1].children[0].value
        });
    }

    for (let r of bcaTable.rows) {
        data.transferBca.push({
            nama: r.cells[0].children[0].value,
            nominal: r.cells[1].children[0].value
        });
    }

    for (let r of mandiriTable.rows) {
        data.transferMandiri.push({
            nama: r.cells[0].children[0].value,
            nominal: r.cells[1].children[0].value
        });
    }

    db.ref("laporan").set(data);
    alert("Data berhasil disimpan!");
}

// ============================
// LOAD FIREBASE
// ============================
db.ref("laporan").on("value", snap => {
    if (!snap.exists()) return;

    const d = snap.val();

    totalPenjualanEl.value = d.totalPenjualan || 0;

    shopeePayEl.value = d.shopeePay || 0;
    shopeeEl.value = d.shopee || 0;

    debitBcaEl.value = d.debitBca || 0;
    kreditBcaEl.value = d.kreditBca || 0;
    qrBcaEl.value = d.qrBca || 0;

    debitMandiriEl.value = d.debitMandiri || 0;
    qrMandiriEl.value = d.qMandiri || 0;

    debitBriEl.value = d.debitBri || 0;
    qrBriEl.value = d.qrBri || 0;

    debitBniEl.value = d.debitBni || 0;
    kreditBniEl.value = d.kreditBni || 0;
    qrBniEl.value = d.qrBni || 0;

    recehEl.value = d.receh || 0;

    p100El.value = d.p100 || 0;
    p50El.value = d.p50 || 0;
    p20El.value = d.p20 || 0;
    p10El.value = d.p10 || 0;
    p5El.value = d.p5 || 0;
    p2El.value = d.p2 || 0;
    p1El.value = d.p1 || 0;

    piutangEl.value = d.piutang || 0;

    // load biaya
    biayaTable.innerHTML = "";
    if (d.biaya) {
        d.biaya.forEach(x => {
            let r = biayaTable.insertRow(-1);
            r.insertCell(0).innerHTML = `<input class="din-input" value="${x.nama}">`;
            r.insertCell(1).innerHTML = `<input class="din-input num" value="${x.nominal}">`;
            r.insertCell(2).innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
        });
    }

    // load BCA
    bcaTable.innerHTML = "";
    if (d.transferBca) {
        d.transferBca.forEach(x => {
            let r = bcaTable.insertRow(-1);
            r.insertCell(0).innerHTML = `<input class="din-input" value="${x.nama}">`;
            r.insertCell(1).innerHTML = `<input class="din-input num" value="${x.nominal}">`;
            r.insertCell(2).innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
        });
    }

    // load MANDIRI
    mandiriTable.innerHTML = "";
    if (d.transferMandiri) {
        d.transferMandiri.forEach(x => {
            let r = mandiriTable.insertRow(-1);
            r.insertCell(0).innerHTML = `<input class="din-input" value="${x.nama}">`;
            r.insertCell(1).innerHTML = `<input class="din-input num" value="${x.nominal}">`;
            r.insertCell(2).innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
        });
    }

    hitung();
});
</script>

</body>
</html>
