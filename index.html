<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Laporan Penjualan Raja Susu Bandung Kopo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #f3f4f6;
      color: #111827;
      padding: 20px;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
    }

    .app-header h1 {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    .status-bar {
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
    }

    .status-bar span {
      font-weight: 600;
    }

    .export-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      background: #2563eb;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s ease;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.1);
    }

    button.success {
      background: #16a34a;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.3);
      filter: brightness(0.97);
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.2fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 18px 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }

    .form-wrapper {
      max-height: 90vh;
      overflow: auto;
    }

    .form-wrapper h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .form-section-title {
      font-size: 12px;
      font-weight: 700;
      margin-top: 14px;
      margin-bottom: 4px;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    label {
      font-size: 12px;
      color: #374151;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      background: #f9fafb;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05);
    }

    input[type="number"] {
      text-align: right;
    }

    input:focus {
      outline: 2px solid #2563eb33;
      border-color: #2563eb;
      background: #ffffff;
    }

    .grid-2,
    .grid-3 {
      display: grid;
      gap: 8px;
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 900px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .grid-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    hr {
      margin: 18px 0;
      border: none;
      border-top: 1px dashed #e5e7eb;
    }

    .dyn-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .dyn-table th,
    .dyn-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
    }

    .dyn-table th {
      background: #f9fafb;
      text-align: left;
      font-weight: 600;
      color: #4b5563;
    }

    .dyn-table input {
      border-radius: 999px;
      width: 100%;
      padding: 5px 8px;
      border: 1px solid #e5e7eb;
      font-size: 11px;
      background: #f9fafb;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05);
    }

    .btn-add {
      padding: 6px 12px;
      border-radius: 999px;
      background: #2563eb;
      color: white;
      font-size: 11px;
      border: none;
      cursor: pointer;
      margin-bottom: 6px;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
    }

    .btn-add:hover {
      filter: brightness(0.97);
    }

    .btn-delete {
      padding: 4px 8px;
      border-radius: 999px;
      background: #dc2626;
      color: white;
      border: none;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-delete:hover {
      filter: brightness(0.96);
    }

    .report-wrapper {
      padding: 20px 22px;
    }

    .report-header {
      text-align: center;
      margin-bottom: 14px;
    }

    .report-header h2 {
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .report-header h3 {
      font-size: 14px;
      font-weight: 600;
      margin-top: 2px;
    }

    .report-header .date {
      margin-top: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #374151;
    }

    .report-grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .report-grid {
        grid-template-columns: 1fr;
      }
    }

    .report-section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 11px;
    }

    .report-table th,
    .report-table td {
      border: 1px solid #e5e7eb;
      padding: 5px 7px;
    }

    .report-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #4b5563;
    }

    .num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .report-summary {
      margin-top: 12px;
    }

    .report-summary table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .report-summary td {
      border: 1px solid #e5e7eb;
      padding: 5px 7px;
    }

    .report-summary td:first-child {
      font-weight: 500;
    }

    .update-note {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .sign {
      margin-top: 10px;
      font-size: 12px;
      text-align: right;
      color: #374151;
    }

    .btn-export {
      margin-top: 14px;
      width: 49%;
      text-align: center;
      justify-content: center;
    }

    @media (max-width: 700px) {
      .btn-export {
        width: 100%;
      }
    }
  </style>

  <!-- Firebase + Tools -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCcDwcdXRnkLaFpYT_kbbjfDwDY-zxoWWY",
      authDomain: "laporan-kopo.firebaseapp.com",
      databaseURL: "https://laporan-kopo-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "laporan-kopo",
      storageBucket: "laporan-kopo.firebasestorage.app",
      messagingSenderId: "556164034130",
      appId: "1:556164034130:web:e9f092dcc77925373c398b",
      measurementId: "G-ZTW27GVCQP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
<div class="app-container">
  <header class="app-header">
    <div>
      <h1>Laporan Penjualan (Tampilan Lama + Fitur Baru)</h1>
      <div id="status-text" class="status-bar">Memuat data dari server...</div>
    </div>
    <div class="export-buttons">
      <button onclick="exportPDF()">üìÑ Export PDF</button>
      <button class="secondary" onclick="exportImage()">üñº Export PNG</button>
      <button class="success" onclick="saveToServer()">üíæ Simpan ke Server</button>
    </div>
  </header>

  <div class="main-layout">
    <!-- FORM -->
    <div class="form-wrapper card">
      <h2>Input Laporan</h2>

      <div class="form-section-title">Informasi Umum</div>
      <div class="form-row">
        <label>Tanggal</label>
        <input type="date" id="input-date">
      </div>
      <div class="form-row">
        <label>Nama Kepala Toko</label>
        <input type="text" id="input-kepala-toko" placeholder="Nama Kepala Toko">
      </div>

      <hr>

      
      <div class="form-section-title">Total Penjualan</div>
      <div class="form-row">
        <label>Total Penjualan</label>
        <input type="number" id="total-penjualan" placeholder="0">
      </div>

      <hr>
<div class="form-section-title">Metode Pembayaran (Non-Cash)</div>
      <p class="hint">Cash dihitung otomatis dari pecahan uang. Isi hanya pembayaran non-cash di bawah ini.</p>

      <div class="form-row"><label>Debit BCA</label><input type="number" id="pay-debit-bca"></div>
      <div class="form-row"><label>Kredit BCA</label><input type="number" id="pay-kredit-bca"></div>
      <div class="form-row"><label>QR BCA</label><input type="number" id="pay-qr-bca"></div>
      <div class="form-row"><label>Debit Mandiri</label><input type="number" id="pay-debit-mandiri"></div>
      <div class="form-row"><label>QR Mandiri</label><input type="number" id="pay-qr-mandiri"></div>
      <div class="form-row"><label>Debit BRI</label><input type="number" id="pay-debit-bri"></div>
      <div class="form-row"><label>QR BRI</label><input type="number" id="pay-qr-bri"></div>
      <div class="form-row"><label>Debit BNI</label><input type="number" id="pay-debit-bni"></div>
      <div class="form-row"><label>Kredit BNI</label><input type="number" id="pay-kredit-bni"></div>
      <div class="form-row"><label>QR BNI</label><input type="number" id="pay-qr-bni"></div>
      <div class="form-row"><label>ShopeePay</label><input type="number" id="pay-shopeepay"></div>
      <div class="form-row"><label>Shopee</label><input type="number" id="pay-shopee"></div>

      <hr>

      <div class="form-section-title">Transfer Bank - BCA</div>
      <table class="dyn-table" id="table-transfer-bca">
        <thead>
          <tr><th>Keterangan</th><th>Nominal</th><th>Aksi</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn-add" onclick="addTransferRow('bca')">+ Tambah Transfer BCA</button>

      <div class="form-section-title" style="margin-top:14px;">Transfer Bank - Mandiri</div>
      <table class="dyn-table" id="table-transfer-mandiri">
        <thead>
          <tr><th>Keterangan</th><th>Nominal</th><th>Aksi</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn-add" onclick="addTransferRow('mandiri')">+ Tambah Transfer Mandiri</button>

      <hr>

      <div class="form-section-title">Pecahan Uang Cash</div>
      <p class="hint">Isi jumlah lembar per pecahan dan receh. Sistem akan hitung total cash fisik.</p>

      <div class="form-row"><label>100.000</label><input type="number" id="denom-100k"></div>
      <div class="form-row"><label>50.000</label><input type="number" id="denom-50k"></div>
      <div class="form-row"><label>20.000</label><input type="number" id="denom-20k"></div>
      <div class="form-row"><label>10.000</label><input type="number" id="denom-10k"></div>
      <div class="form-row"><label>5.000</label><input type="number" id="denom-5k"></div>
      <div class="form-row"><label>Receh</label><input type="number" id="cash-receh"></div>

      <hr>

      <div class="form-section-title">Biaya Operasional</div>
      <p class="hint">Tambahkan biaya seperti parkir, galon, ATK, dll.</p>
      <table class="dyn-table" id="table-biaya">
        <thead>
          <tr><th>Nama Biaya</th><th>Nominal</th><th>Aksi</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn-add" onclick="addBiayaRow()">+ Tambah Biaya</button>

      <hr>

      <div class="form-section-title">Piutang</div>
      <div class="form-row">
        <label>Total Piutang Hari Ini</label>
        <input type="number" id="piutang">
      </div>
    </div>

    <!-- REPORT -->
    <div class="report-wrapper card" id="report-area">
      <div class="report-header">
        <h2>LAPORAN PENJUALAN</h2>
        <h3>RAJA SUSU BANDUNG KOPO</h3>
        <div class="date" id="report-date">-</div>
      </div>

      <div class="report-grid">
        <div>
          <div class="report-section-title">Metode Non-Cash</div>
          <table id="payment-table" class="report-table">
            <thead><tr><th>Item</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>

          <div class="report-section-title">Transfer</div>
          <table id="transfer-table" class="report-table">
            <thead><tr><th>Bank</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>

          <div class="report-section-title">Biaya</div>
          <table id="biaya-table" class="report-table">
            <thead><tr><th>Nama</th><th>Nominal</th></tr></thead>
            <tbody></tbody>
          </table>

          <div class="report-section-title">Piutang</div>
          <table id="piutang-table" class="report-table">
            <tbody></tbody>
          </table>
        </div>

        <div>
          <div class="report-section-title">Pecahan Cash</div>
          <table id="denom-table" class="report-table">
            <thead><tr><th>Nominal</th><th>Lembar</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>

          <div class="report-section-title">Ringkasan Cash</div>
          <table id="cash-summary-table" class="report-table">
            <tbody>
              <!-- bisa diisi jika ingin detail tambahan cash -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="report-summary">
        <table>
          <tbody>
          <tr><td>Total Non-Cash</td><td id="total-non-cash" class="num">0</td></tr>
          <tr><td>Total Transfer</td><td id="total-transfer" class="num">0</td></tr>
          <tr><td>Total Biaya</td><td id="total-biaya" class="num">0</td></tr>
          <tr><td>Total Cash Fisik</td><td id="total-cash-fisik" class="num">0</td></tr>
          <tr><td>Subtotal</td><td id="subtotal" class="num">0</td></tr>
          <tr><td>Grand Total</td><td id="grandtotal" class="num">0</td></tr>
          <tr><td style="color:#2563eb;">Plus / Minus</td><td id="plusminus" class="num">0</td></tr>
          <tr><td style="color:#dc2626;">Minus Asli</td><td id="minusasli" class="num">0</td></tr>
          </tbody>
        </table>
      </div>

      <p id="updated-at-note" class="update-note">Terakhir diperbarui: -</p>
      <p class="sign">Paraf Kepala Toko: <b id="kepala-toko-name">-</b></p>
    </div>
  </div>

  <button class="btn-export" onclick="exportPDF()">üìÑ Export PDF</button>
  <button class="btn-export" onclick="exportImage()">üñº Export PNG</button>
</div>

<script>
  const fmt = n => Number(n).toLocaleString("id-ID");
  const val = id => Number(document.getElementById(id).value || 0);
  const MAX_ROWS = 10;

  function addTransferRow(bank) {
    const tableId = bank === "bca" ? "table-transfer-bca" : "table-transfer-mandiri";
    const tbody = document.getElementById(tableId).querySelector("tbody");
    if (tbody.children.length >= MAX_ROWS) {
      alert("Maksimal 10 baris!");
      return;
    }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="text" class="row-name" placeholder="Keterangan"></td>
      <td><input type="number" class="row-nominal" oninput="calculate()"></td>
      <td><button class="btn-delete" onclick="removeRow(this)">‚ùå</button></td>
    `;
    tbody.appendChild(tr);
    calculate();
  }

  function addBiayaRow() {
    const tbody = document.getElementById("table-biaya").querySelector("tbody");
    if (tbody.children.length >= MAX_ROWS) {
      alert("Maksimal 10 baris!");
      return;
    }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="text" class="row-name" placeholder="Nama Biaya"></td>
      <td><input type="number" class="row-nominal" oninput="calculate()"></td>
      <td><button class="btn-delete" onclick="removeRow(this)">‚ùå</button></td>
    `;
    tbody.appendChild(tr);
    calculate();
  }

  function removeRow(btn) {
    btn.parentElement.parentElement.remove();
    calculate();
  }

  function sumTransfer(tableId) {
    let sum = 0;
    document.querySelectorAll(`#${tableId} tbody tr`).forEach(r => {
      sum += Number(r.querySelector(".row-nominal").value || 0);
    });
    return sum;
  }

  function calculate() {
    const nonCashValues = [
      val("pay-debit-bca"), val("pay-kredit-bca"), val("pay-qr-bca"),
      val("pay-debit-mandiri"), val("pay-qr-mandiri"),
      val("pay-debit-bri"), val("pay-qr-bri"),
      val("pay-debit-bni"), val("pay-kredit-bni"), val("pay-qr-bni"),
      val("pay-shopeepay"), val("pay-shopee")
    ];
    const totalNonCash = nonCashValues.reduce((a, b) => a + b, 0);
    document.getElementById("total-non-cash").textContent = fmt(totalNonCash);

    const totalBCA = sumTransfer("table-transfer-bca");
    const totalMANDIRI = sumTransfer("table-transfer-mandiri");
    const totalTransfer = totalBCA + totalMANDIRI;
    document.getElementById("total-transfer").textContent = fmt(totalTransfer);

    let totalBiaya = 0;
    document.querySelectorAll("#table-biaya tbody tr").forEach(r => {
      totalBiaya += Number(r.querySelector(".row-nominal").value || 0);
    });
    document.getElementById("total-biaya").textContent = fmt(totalBiaya);

    const cashFisik =
      val("denom-100k") * 100000 +
      val("denom-50k") * 50000 +
      val("denom-20k") * 20000 +
      val("denom-10k") * 10000 +
      val("denom-5k") * 5000 +
      val("cash-receh");

    document.getElementById("total-cash-fisik").textContent = fmt(cashFisik);

    const subtotal = totalNonCash + totalTransfer + cashFisik + val("piutang");
    document.getElementById("subtotal").textContent = fmt(subtotal);

    const grand = subtotal - totalBiaya;
    document.getElementById("grandtotal").textContent = fmt(grand);

    const cashSeharusnya = grand - totalNonCash - totalTransfer - val("piutang");
    const plusMinus = cashFisik - cashSeharusnya;
    document.getElementById("plusminus").textContent = fmt(plusMinus);

    const minusAsli = plusMinus < 0 ? plusMinus : 0;
    document.getElementById("minusasli").textContent = fmt(minusAsli);

    renderReport();
  }

  function renderReport() {
    const payments = [
      ["Debit BCA", val("pay-debit-bca")],
      ["Kredit BCA", val("pay-kredit-bca")],
      ["QR BCA", val("pay-qr-bca")],
      ["Debit Mandiri", val("pay-debit-mandiri")],
      ["QR Mandiri", val("pay-qr-mandiri")],
      ["Debit BRI", val("pay-debit-bri")],
      ["QR BRI", val("pay-qr-bri")],
      ["Debit BNI", val("pay-debit-bni")],
      ["Kredit BNI", val("pay-kredit-bni")],
      ["QR BNI", val("pay-qr-bni")],
      ["ShopeePay", val("pay-shopeepay")],
      ["Shopee", val("pay-shopee")]
    ];
    let payHTML = "";
    payments.forEach(p => {
      if (p[1] > 0) {
        payHTML += `<tr><td>${p[0]}</td><td class="num">${fmt(p[1])}</td></tr>`;
      }
    });
    document.querySelector("#payment-table tbody").innerHTML = payHTML;

    const transferHTML = `
      <tr><td>BCA</td><td class="num">${fmt(sumTransfer("table-transfer-bca"))}</td></tr>
      <tr><td>Mandiri</td><td class="num">${fmt(sumTransfer("table-transfer-mandiri"))}</td></tr>
    `;
    document.querySelector("#transfer-table tbody").innerHTML = transferHTML;

    let biayaHTML = "";
    document.querySelectorAll("#table-biaya tbody tr").forEach(r => {
      const nama = r.querySelector(".row-name").value || "-";
      const nom = Number(r.querySelector(".row-nominal").value || 0);
      if (nom > 0) biayaHTML += `<tr><td>${nama}</td><td class="num">${fmt(nom)}</td></tr>`;
    });
    document.querySelector("#biaya-table tbody").innerHTML = biayaHTML;

    document.querySelector("#piutang-table tbody").innerHTML =
      `<tr><td>Piutang</td><td class="num">${fmt(val("piutang"))}</td></tr>`;

    const denomData = [
      ["100.000", val("denom-100k"), val("denom-100k") * 100000],
      ["50.000", val("denom-50k"), val("denom-50k") * 50000],
      ["20.000", val("denom-20k"), val("denom-20k") * 20000],
      ["10.000", val("denom-10k"), val("denom-10k") * 10000],
      ["5.000", val("denom-5k"), val("denom-5k") * 5000],
      ["Receh", "-", val("cash-receh")]
    ];
    let denomHTML = "";
    denomData.forEach(d => {
      denomHTML += `<tr><td>${d[0]}</td><td class="num">${d[1]}</td><td class="num">${fmt(d[2])}</td></tr>`;
    });
    document.querySelector("#denom-table tbody").innerHTML = denomHTML;

    document.getElementById("report-date").textContent =
      document.getElementById("input-date").value || "-";
    document.getElementById("kepala-toko-name").textContent =
      document.getElementById("input-kepala-toko").value || "-";
  }

  function saveToServer() {
    calculate();

    const data = {
      tanggal: document.getElementById("input-date").value,
      kepalaToko: document.getElementById("input-kepala-toko").value,
      nonCash: {
        debit_bca: val("pay-debit-bca"),
        kredit_bca: val("pay-kredit-bca"),
        qr_bca: val("pay-qr-bca"),
        debit_mandiri: val("pay-debit-mandiri"),
        qr_mandiri: val("pay-qr-mandiri"),
        debit_bri: val("pay-debit-bri"),
        qr_bri: val("pay-qr-bri"),
        debit_bni: val("pay-debit-bni"),
        kredit_bni: val("pay-kredit-bni"),
        qr_bni: val("pay-qr-bni"),
        shopeepay: val("pay-shopeepay"),
        shopee: val("pay-shopee")
      },
      transferBCA: [],
      transferMandiri: [],
      biaya: [],
      pecahan: {
        d100: val("denom-100k"),
        d50: val("denom-50k"),
        d20: val("denom-20k"),
        d10: val("denom-10k"),
        d5: val("denom-5k"),
        receh: val("cash-receh")
      },
      piutang: val("piutang"),
      hitungan: {
        totalNonCash: Number(document.getElementById("total-non-cash").textContent.replace(/\./g,"")),
        totalTransfer: Number(document.getElementById("total-transfer").textContent.replace(/\./g,"")),
        totalBiaya: Number(document.getElementById("total-biaya").textContent.replace(/\./g,"")),
        totalCashFisik: Number(document.getElementById("total-cash-fisik").textContent.replace(/\./g,"")),
        subtotal: Number(document.getElementById("subtotal").textContent.replace(/\./g,"")),
        grandtotal: Number(document.getElementById("grandtotal").textContent.replace(/\./g,"")),
        plusminus: Number(document.getElementById("plusminus").textContent.replace(/\./g,"")),
        minusasli: Number(document.getElementById("minusasli").textContent.replace(/\./g,""))
      },
      updatedAt: new Date().toLocaleString("id-ID")
    };

    document.querySelectorAll("#table-transfer-bca tbody tr").forEach(r => {
      data.transferBCA.push({
        ket: r.querySelector(".row-name").value,
        nominal: Number(r.querySelector(".row-nominal").value || 0)
      });
    });

    document.querySelectorAll("#table-transfer-mandiri tbody tr").forEach(r => {
      data.transferMandiri.push({
        ket: r.querySelector(".row-name").value,
        nominal: Number(r.querySelector(".row-nominal").value || 0)
      });
    });

    document.querySelectorAll("#table-biaya tbody tr").forEach(r => {
      data.biaya.push({
        nama: r.querySelector(".row-name").value,
        nominal: Number(r.querySelector(".row-nominal").value || 0)
      });
    });

    db.ref("laporan_otomatis").set(data).then(() => {
      alert("Data berhasil disimpan!");
      document.getElementById("updated-at-note").textContent =
        "Terakhir diperbarui: " + data.updatedAt;
      document.getElementById("status-text").innerHTML =
        `Data berhasil disimpan ‚Ä¢ <span>${data.updatedAt}</span>`;
    }).catch(err => {
      alert("Gagal menyimpan: " + err.message);
    });
  }

  db.ref("laporan_otomatis").on("value", snap => {
    if (!snap.exists()) {
      document.getElementById("status-text").textContent =
        "Belum ada data tersimpan. Silakan isi dan simpan.";
      return;
    }

    const d = snap.val();
    document.getElementById("input-date").value = d.tanggal || "";
    document.getElementById("input-kepala-toko").value = d.kepalaToko || "";

    if (d.nonCash) {
      const nc = d.nonCash;
      document.getElementById("pay-debit-bca").value = nc.debit_bca || 0;
      document.getElementById("pay-kredit-bca").value = nc.kredit_bca || 0;
      document.getElementById("pay-qr-bca").value = nc.q_bca || nc.qr_bca || 0;
      document.getElementById("pay-debit-mandiri").value = nc.debit_mandiri || 0;
      document.getElementById("pay-qr-mandiri").value = nc.qr_mandiri || 0;
      document.getElementById("pay-debit-bri").value = nc.debit_bri || 0;
      document.getElementById("pay-qr-bri").value = nc.qr_bri || 0;
      document.getElementById("pay-debit-bni").value = nc.debit_bni || 0;
      document.getElementById("pay-kredit-bni").value = nc.kredit_bni || 0;
      document.getElementById("pay-qr-bni").value = nc.qr_bni || 0;
      document.getElementById("pay-shopeepay").value = nc.shopeepay || 0;
      document.getElementById("pay-shopee").value = nc.shopee || 0;
    }

    const tbodyBCA = document.querySelector("#table-transfer-bca tbody");
    tbodyBCA.innerHTML = "";
    d.transferBCA && d.transferBCA.forEach(t => {
      addTransferRow("bca");
      const row = tbodyBCA.lastElementChild;
      row.querySelector(".row-name").value = t.ket;
      row.querySelector(".row-nominal").value = t.nominal;
    });

    const tbodyMAN = document.querySelector("#table-transfer-mandiri tbody");
    tbodyMAN.innerHTML = "";
    d.transferMandiri && d.transferMandiri.forEach(t => {
      addTransferRow("mandiri");
      const row = tbodyMAN.lastElementChild;
      row.querySelector(".row-name").value = t.ket;
      row.querySelector(".row-nominal").value = t.nominal;
    });

    const tbodyBiaya = document.querySelector("#table-biaya tbody");
    tbodyBiaya.innerHTML = "";
    d.biaya && d.biaya.forEach(b => {
      addBiayaRow();
      const row = tbodyBiaya.lastElementChild;
      row.querySelector(".row-name").value = b.nama;
      row.querySelector(".row-nominal").value = b.nominal;
    });

    if (d.pecahan) {
      const p = d.pecahan;
      document.getElementById("denom-100k").value = p.d100 || 0;
      document.getElementById("denom-50k").value = p.d50 || 0;
      document.getElementById("denom-20k").value = p.d20 || 0;
      document.getElementById("denom-10k").value = p.d10 || 0;
      document.getElementById("denom-5k").value = p.d5 || 0;
      document.getElementById("cash-receh").value = p.receh || 0;
    }

    document.getElementById("piutang").value = d.piutang || 0;
    document.getElementById("updated-at-note").textContent =
      "Terakhir diperbarui: " + (d.updatedAt || "-");
    document.getElementById("status-text").innerHTML =
      `Menampilkan data terakhir dari server ‚Ä¢ <span>${d.updatedAt || "-"}</span>`;
    calculate();
  });

  async function exportImage() {
    const el = document.getElementById("report-area");
    const canvas = await html2canvas(el, { scale: 2 });
    const link = document.createElement("a");
    link.download = "laporan.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  async function exportPDF() {
    const el = document.getElementById("report-area");
    const canvas = await html2canvas(el, { scale: 2 });
    const img = canvas.toDataURL("image/png");

    const pdf = new jspdf.jsPDF("p", "mm", "a4");
    const width = 190;
    const height = (canvas.height * width) / canvas.width;

    pdf.addImage(img, "PNG", 10, 10, width, height);
    pdf.save("laporan.pdf");
  }

  calculate();
</script>
<script>
<script>
// ========== Helper: Format angka ==========
function num(v) {
    v = parseFloat(v);
    return isNaN(v) ? 0 : v;
}

function format(v) {
    return num(v).toLocaleString("id-ID");
}

// ============================
// Ambil elemen input
// ============================
const totalPenjualanEl = document.getElementById("totalPenjualan");

const shopeePayEl = document.getElementById("shopeePay");
const shopeeEl = document.getElementById("shopee");

const debitBcaEl = document.getElementById("debitBca");
const kreditBcaEl = document.getElementById("kreditBca");
const qrBcaEl = document.getElementById("qrBca");

const debitMandiriEl = document.getElementById("debitMandiri");
const qrMandiriEl = document.getElementById("qrMandiri");

const debitBriEl = document.getElementById("debitBri");
const qrBriEl = document.getElementById("qrBri");

const debitBniEl = document.getElementById("debitBni");
const kreditBniEl = document.getElementById("kreditBni");
const qrBniEl = document.getElementById("qrBni");

const recehEl = document.getElementById("receh");

// Pecahan
const p100El = document.getElementById("p100");
const p50El = document.getElementById("p50");
const p20El = document.getElementById("p20");
const p10El = document.getElementById("p10");
const p5El = document.getElementById("p5");
const p2El = document.getElementById("p2");
const p1El = document.getElementById("p1");

// Piutang
const piutangEl = document.getElementById("piutang");

// Dynamic tables
const biayaTable = document.getElementById("biayaTable");
const btnAddBiaya = document.getElementById("addBiaya");

const bcaTable = document.getElementById("bcaTable");
const btnAddBca = document.getElementById("addBca");

const mandiriTable = document.getElementById("mandiriTable");
const btnAddMandiri = document.getElementById("addMandiri");


// ============================
// Tambah Dynamic Row
// ============================
function addRow(table, max) {
    if (table.rows.length >= max) return alert("Maksimal " + max + " baris!");

    let row = table.insertRow(-1);

    let c1 = row.insertCell(0);
    let c2 = row.insertCell(1);
    let c3 = row.insertCell(2);

    c1.innerHTML = `<input type="text" class="din-input">`;
    c2.innerHTML = `<input type="number" class="din-input num">`;
    c3.innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
}

// Tombol tambah
btnAddBiaya.onclick = () => addRow(biayaTable, 10);
btnAddBca.onclick = () => addRow(bcaTable, 10);
btnAddMandiri.onclick = () => addRow(mandiriTable, 10);


// ============================
// HITUNG AUTOMATIS
// ============================
function hitung() {

    // 1. TOTAL PENJUALAN
    const totalPenjualan = num(totalPenjualanEl.value);

    // 2. TOTAL NON-CASH
    const totalNonCash =
        num(shopeePayEl.value) +
        num(shopeeEl.value) +
        num(debitBcaEl.value) +
        num(kreditBcaEl.value) +
        num(qrBcaEl.value) +
        num(debitMandiriEl.value) +
        num(qrMandiriEl.value) +
        num(debitBriEl.value) +
        num(qrBriEl.value) +
        num(debitBniEl.value) +
        num(kreditBniEl.value) +
        num(qrBniEl.value);

    // 3. TOTAL TRANSFER BCA + MANDIRI (DARI TABEL)
    let totalTransferBca = 0;
    for (let r of bcaTable.rows) {
        totalTransferBca += num(r.cells[1].children[0].value);
    }

    let totalTransferMandiri = 0;
    for (let r of mandiriTable.rows) {
        totalTransferMandiri += num(r.cells[1].children[0].value);
    }

    const totalTransfer = totalTransferBca + totalTransferMandiri;

    // 4. TOTAL BIAYA
    let totalBiaya = 0;
    for (let r of biayaTable.rows) {
        totalBiaya += num(r.cells[1].children[0].value);
    }

    // 5. PIUTANG
    const piutang = num(piutangEl.value);

    // 6. SUBTOTAL = total penjualan (kotor)
    const subtotal = totalPenjualan;

    // 7. GRAND TOTAL = TOTAL PENJUALAN - biaya
    const grandTotal = subtotal - totalBiaya;

    // 8. CASH FISIK = pecahan + receh
    const cashFisik =
        (num(p100El.value) * 100000) +
        (num(p50El.value) * 50000) +
        (num(p20El.value) * 20000) +
        (num(p10El.value) * 10000) +
        (num(p5El.value) * 5000) +
        (num(p2El.value) * 2000) +
        (num(p1El.value) * 1000) +
        num(recehEl.value);

    // 9. CASH SEHARUSNYA
    const cashSeharusnya = grandTotal - totalNonCash - totalTransfer - piutang;

    // 10. PLUS MINUS
    const plusMinus = cashFisik - cashSeharusnya;

    // 11. MINUS ASLI
    const minusAsli = plusMinus < 0 ? Math.abs(plusMinus) : 0;

    // =========================
    // TAMPILKAN DI LAPORAN
    // =========================
    document.getElementById("r_totalPenjualan").innerText = format(totalPenjualan);
    document.getElementById("r_totalNonCash").innerText = format(totalNonCash);
    document.getElementById("r_totalTransfer").innerText = format(totalTransfer);
    document.getElementById("r_totalBiaya").innerText = format(totalBiaya);
    document.getElementById("r_subtotal").innerText = format(subtotal);
    document.getElementById("r_grandTotal").innerText = format(grandTotal);
    document.getElementById("r_cashFisik").innerText = format(cashFisik);
    document.getElementById("r_cashSeharusnya").innerText = format(cashSeharusnya);
    document.getElementById("r_plusminus").innerText = format(plusMinus);
    document.getElementById("r_minusAsli").innerText = format(minusAsli);

}

document.addEventListener("input", hitung);


// ============================
// EXPORT PNG
// ============================
async function exportPNG() {
    const laporan = document.getElementById("laporan");
    const canvas = await html2canvas(laporan);
    const link = document.createElement("a");
    link.download = "laporan.png";
    link.href = canvas.toDataURL();
    link.click();
}

// ============================
// EXPORT PDF
// ============================
async function exportPDF() {
    const laporan = document.getElementById("laporan");
    const canvas = await html2canvas(laporan);
    const imgData = canvas.toDataURL("image/png");

    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, w, h);
    pdf.save("laporan.pdf");
}

// ============================
// SAVE FIREBASE
// ============================
function saveServer() {
    const data = {
        totalPenjualan: totalPenjualanEl.value,
        shopeePay: shopeePayEl.value,
        shopee: shopeeEl.value,
        debitBca: debitBcaEl.value,
        kreditBca: kreditBcaEl.value,
        qrBca: qrBcaEl.value,
        debitMandiri: debitMandiriEl.value,
        qrMandiri: qrMandiriEl.value,
        debitBri: debitBriEl.value,
        qrBri: qrBriEl.value,
        debitBni: debitBniEl.value,
        kreditBni: kreditBniEl.value,
        qrBni: qrBniEl.value,
        receh: recehEl.value,
        p100: p100El.value,
        p50: p50El.value,
        p20: p20El.value,
        p10: p10El.value,
        p5: p5El.value,
        p2: p2El.value,
        p1: p1El.value,
        piutang: piutangEl.value,
        biaya: [],
        transferBca: [],
        transferMandiri: []
    };

    for (let r of biayaTable.rows) {
        data.biaya.push({
            nama: r.cells[0].children[0].value,
            nominal: r.cells[1].children[0].value
        });
    }

    for (let r of bcaTable.rows) {
        data.transferBca.push({
            nama: r.cells[0].children[0].value,
            nominal: r.cells[1].children[0].value
        });
    }

    for (let r of mandiriTable.rows) {
        data.transferMandiri.push({
            nama: r.cells[0].children[0].value,
            nominal: r.cells[1].children[0].value
        });
    }

    db.ref("laporan").set(data);
    alert("Data berhasil disimpan!");
}

// ============================
// LOAD FIREBASE
// ============================
db.ref("laporan").on("value", snap => {
    if (!snap.exists()) return;

    const d = snap.val();

    totalPenjualanEl.value = d.totalPenjualan || 0;

    shopeePayEl.value = d.shopeePay || 0;
    shopeeEl.value = d.shopee || 0;

    debitBcaEl.value = d.debitBca || 0;
    kreditBcaEl.value = d.kreditBca || 0;
    qrBcaEl.value = d.qrBca || 0;

    debitMandiriEl.value = d.debitMandiri || 0;
    qrMandiriEl.value = d.qMandiri || 0;

    debitBriEl.value = d.debitBri || 0;
    qrBriEl.value = d.qrBri || 0;

    debitBniEl.value = d.debitBni || 0;
    kreditBniEl.value = d.kreditBni || 0;
    qrBniEl.value = d.qrBni || 0;

    recehEl.value = d.receh || 0;

    p100El.value = d.p100 || 0;
    p50El.value = d.p50 || 0;
    p20El.value = d.p20 || 0;
    p10El.value = d.p10 || 0;
    p5El.value = d.p5 || 0;
    p2El.value = d.p2 || 0;
    p1El.value = d.p1 || 0;

    piutangEl.value = d.piutang || 0;

    // load biaya
    biayaTable.innerHTML = "";
    if (d.biaya) {
        d.biaya.forEach(x => {
            let r = biayaTable.insertRow(-1);
            r.insertCell(0).innerHTML = `<input class="din-input" value="${x.nama}">`;
            r.insertCell(1).innerHTML = `<input class="din-input num" value="${x.nominal}">`;
            r.insertCell(2).innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
        });
    }

    // load BCA
    bcaTable.innerHTML = "";
    if (d.transferBca) {
        d.transferBca.forEach(x => {
            let r = bcaTable.insertRow(-1);
            r.insertCell(0).innerHTML = `<input class="din-input" value="${x.nama}">`;
            r.insertCell(1).innerHTML = `<input class="din-input num" value="${x.nominal}">`;
            r.insertCell(2).innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
        });
    }

    // load MANDIRI
    mandiriTable.innerHTML = "";
    if (d.transferMandiri) {
        d.transferMandiri.forEach(x => {
            let r = mandiriTable.insertRow(-1);
            r.insertCell(0).innerHTML = `<input class="din-input" value="${x.nama}">`;
            r.insertCell(1).innerHTML = `<input class="din-input num" value="${x.nominal}">`;
            r.insertCell(2).innerHTML = `<button class="btn-delete" onclick="this.parentNode.parentNode.remove(); hitung();">Hapus</button>`;
        });
    }

    hitung();
});

</script>

</script>
</body>
</html>